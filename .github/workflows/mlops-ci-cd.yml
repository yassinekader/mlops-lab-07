name: MLOps CI/CD manifest


on:
  push:
    branches: ["main", "master"]
  pull_request:


jobs:
  ci:
    runs-on: ubuntu-latest


    steps:
      - uses: actions/checkout@v4


      - uses: actions/setup-python@v5
        with:
          python-version: ${{ vars.PY_VERSION }}


      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ vars.PY_VERSION }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-${{ vars.PY_VERSION }}-


      - name: Installer dépendances
        run: |
          pip install -U pip
          pip install dvc pandas numpy scikit-learn joblib


      - name: Restaurer cache DVC
        uses: actions/cache@v4
        with:
          path: .dvc/cache
          key: dvc-${{ runner.os }}-${{ vars.PY_VERSION }}-${{ github.sha }}
          restore-keys: |
            dvc-${{ runner.os }}-${{ vars.PY_VERSION }}-


      - name: Afficher le DAG DVC
        run: dvc dag


      - name: Générer données brutes
        run: python src/generate_data.py


      - name: Exécuter pipeline ML via DVC
        run: dvc repro


      - name: Vérifier métriques (Quality Gate F1)
        run: |
          python - << 'EOF'
          import json
          threshold = float("${{ vars.F1_GATE_THRESHOLD }}")
          with open("reports/metrics.json", "r", encoding="utf-8") as f:
              metrics = json.load(f)
          f1 = float(metrics.get("f1", 0.0))
          print(f"F1={f1} | seuil={threshold}")
          if f1 < threshold:
              raise SystemExit("Quality Gate échoué : F1 insuffisante")
          print("Quality Gate validé")
          EOF


      - name: Upload artefacts ML
        uses: actions/upload-artifact@v4
        with:
          name: ml-artifacts
          path: |
            models/
            registry/
            reports/


  cd:
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'


    steps:
      - uses: actions/checkout@v4


      - name: Télécharger artefacts validés
        uses: actions/download-artifact@v4
        with:
          name: ml-artifacts
          path: release_artifacts


      - name: CD simulé (déploiement SSH)
        run: |
          echo "=== Phase CD (simulée) ==="
          echo "ENV               : ${{ vars.APP_ENV }}"
          echo "F1 gate           : ${{ vars.F1_GATE_THRESHOLD }}"
          echo "Secret (demo)     : ${{ secrets.DEMO_SECRET }}"
          echo
          echo "Artefacts prêts :"
          ls -R release_artifacts
          echo
          echo "Simulation SSH : ssh user@server 'deploy release_artifacts/'"
